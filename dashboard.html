<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EduAI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .glass-card { backdrop-filter: blur(16px); background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .active-tab { background-color: rgba(255, 255, 255, 0.2); }
        .chat-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; }
        .user-bubble { background-color: #eef2ff; color: #4338ca; align-self: flex-end; }
        .ai-bubble { background-color: #f3f4f6; color: #1f2937; align-self: flex-start; }
        .kahoot-btn { transition: transform 0.1s ease-in-out; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.125rem; color: white; padding: 1rem; border-radius: 0.5rem; }
        .kahoot-btn:hover { transform: scale(1.03); }
        .kahoot-red { background-color: #ef4444; }
        .kahoot-blue { background-color: #3b82f6; }
        .kahoot-yellow { background-color: #eab308; }
        .kahoot-green { background-color: #22c55e; }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <div class="fixed inset-y-0 left-0 w-64 gradient-bg text-white shadow-lg flex flex-col">
        <div>
            <div class="flex items-center justify-center h-16 px-4 border-b border-indigo-400/20">
                <div class="flex items-center space-x-2"><i data-feather="book-open" class="w-8 h-8 text-indigo-200"></i><h1 class="text-xl font-bold">EduAI Companion</h1></div>
            </div>
            <div class="p-4">
                <div class="flex items-center space-x-3 mb-6 p-3 glass-card rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center"><span id="userInitials"></span></div>
                    <div><p id="userName"></p><p id="userRole" class="text-xs text-indigo-200"></p></div>
                </div>
                <nav id="sidebar-nav"></nav>
            </div>
        </div>
        <div class="mt-auto p-4 border-t border-indigo-400/20">
            <a href="#" id="logout-btn" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition">
                <i data-feather="log-out" class="w-5 h-5"></i><span>Log Out</span>
            </a>
        </div>
    </div>

    <main class="ml-64 p-8 min-h-screen"></main>

    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4">
            <form id="addUserForm" class="p-6">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-800">Add New User</h3><button type="button" id="closeModalBtn" class="text-gray-500 hover:text-gray-700"><i data-feather="x" class="w-5 h-5"></i></button></div>
                <div class="space-y-4">
                    <div><label for="newUserEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="newUserEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div><label for="newUserPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="newUserPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div><label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label><select id="newUserRole" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="alumno">Student</option><option value="profesor">Teacher</option><option value="admin">Admin</option></select></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancelModalBtn" class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg transition">Cancel</button><button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg transition">Save User</button></div>
            </form>
        </div>
    </div>

    <script>
        const user = { name: localStorage.getItem('userName') || '', role: localStorage.getItem('userRole') || 'alumno' };

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            updateUserInfo();
            setupNavigationAndViews();
            document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); logout(); });
        });

        function updateUserInfo() {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userInitials').textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const roleDisplay = { 'alumno': 'Student', 'profesor': 'Teacher', 'admin': 'Administrator' };
            document.getElementById('userRole').textContent = roleDisplay[user.role] || 'Unknown';
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        function setupNavigationAndViews() {
            const nav = document.getElementById('sidebar-nav');
            const main = document.querySelector('main');
            nav.innerHTML = ''; 
            main.innerHTML = '';

            let views = {};
            if (user.role === 'admin') {
                views = { 'Admin Dashboard': { icon: 'sliders', content: adminDashboardView() } };
            } else {
                views = {
                    'AI Tutor': { icon: 'message-square', content: aiTutorView() },
                    'Study Materials': { icon: 'file-text', content: '<div>Study Materials Content Here</div>' },
                    'Quizzes': { icon: 'check-square', content: quizzesView() }
                };
            }

            Object.keys(views).forEach(name => {
                const viewId = name.toLowerCase().replace(' ', '-');
                const link = document.createElement('a');
                link.href = '#';
                link.id = `nav-${viewId}`;
                link.className = 'flex items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition';
                link.innerHTML = `<i data-feather="${views[name].icon}" class="w-5 h-5"></i><span>${name}</span>`;
                link.addEventListener('click', (e) => { e.preventDefault(); showView(viewId); });
                nav.appendChild(link);

                const viewContainer = document.createElement('div');
                viewContainer.id = viewId;
                viewContainer.className = 'hidden';
                viewContainer.innerHTML = views[name].content;
                main.appendChild(viewContainer);
            });

            feather.replace();
            const firstViewId = Object.keys(views)[0].toLowerCase().replace(' ', '-');
            showView(firstViewId);
        }

        function showView(viewId) {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.querySelectorAll('#sidebar-nav a').forEach(a => a.classList.remove('active-tab'));
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById(`nav-${viewId}`).classList.add('active-tab');

            if (viewId === 'admin-dashboard') {
                // Si la vista de admin se muestra, cargamos sus datos y añadimos los event listeners
                loadAdminStats();
                loadUsersTable();
                
                const addUserModal = document.getElementById('addUserModal');
                const addUserBtn = document.getElementById('addUserBtn');
                const closeModalBtn = document.getElementById('closeModalBtn');
                const cancelModalBtn = document.getElementById('cancelModalBtn');
                addUserBtn.addEventListener('click', () => addUserModal.classList.remove('hidden'));
                closeModalBtn.addEventListener('click', () => addUserModal.classList.add('hidden'));
                cancelModalBtn.addEventListener('click', () => addUserModal.classList.add('hidden'));
                document.getElementById('addUserForm').addEventListener('submit', handleAddNewUser);
                
                const searchInput = document.getElementById('user-search-input');
                searchInput.addEventListener('keyup', () => { loadUsersTable(searchInput.value); });
            }
            if (viewId === 'quizzes') {
                loadQuizzes();
            }
        }
        
        // --- PLANTILLAS DE VISTAS ---

        function adminDashboardView() {
            // ///
            // //  AQUÍ ESTÁ EL CÓDIGO RESTAURADO DEL PANEL DE ADMIN  //
            // ///
            return `
                <header class="mb-8"><h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2></header>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-blue-100 p-3 rounded-full"><i data-feather="users" class="w-6 h-6 text-blue-600"></i></div><div><p class="text-gray-500 text-sm">Total Students</p><p id="stats-students" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-green-100 p-3 rounded-full"><i data-feather="user-check" class="w-6 h-6 text-green-600"></i></div><div><p class="text-gray-500 text-sm">Total Teachers</p><p id="stats-teachers" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-purple-100 p-3 rounded-full"><i data-feather="check-square" class="w-6 h-6 text-purple-600"></i></div><div><p class="text-gray-500 text-sm">Total Quizzes</p><p id="stats-quizzes" class="text-2xl font-bold">0</p></div></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm">
                    <div class="p-6 border-b flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h3 class="text-lg font-medium">User Management</h3>
                        <div class="flex items-center gap-4">
                            <input type="text" id="user-search-input" placeholder="Search by email..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="addUserBtn" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition whitespace-nowrap"><i data-feather="plus" class="w-4 h-4 inline -mt-0.5"></i> Add New User</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">Email</th><th class="px-6 py-3">Role</th><th class="px-6 py-3">Actions</th></tr></thead><tbody id="user-table-body"></tbody></table>
                    </div>
                </div>
            `;
        }
        
        function aiTutorView() { /* ... (sin cambios) ... */ }
        function quizzesView() { /* ... (sin cambios) ... */ }

        // --- LÓGICA DE ADMIN Y QUIZZES (sin cambios) ---
        async function handleAddNewUser(event) { /* ... */ }
        async function loadAdminStats() { /* ... */ }
        async function loadUsersTable(searchTerm = '') { /* ... */ }
        async function deleteUser(id, username) { /* ... */ }
        let quizData = [];
        async function loadQuizzes() { /* ... */ }
        function showQuizQuestion(quizId, questionIndex) { /* ... */ }
    </script>
</body>
</html>
