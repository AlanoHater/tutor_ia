<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EduAI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .glass-card { backdrop-filter: blur(16px); background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .active-tab { background-color: rgba(255, 255, 255, 0.2); }
        .view { display: none; animation: fadeIn 0.5s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <div class="fixed inset-y-0 left-0 w-64 gradient-bg text-white shadow-lg flex flex-col">
        <div>
            <div class="flex items-center justify-center h-16 px-4 border-b border-indigo-400/20">
                <div class="flex items-center space-x-2"><i data-feather="book-open" class="w-8 h-8 text-indigo-200"></i><h1 class="text-xl font-bold">EduAI Companion</h1></div>
            </div>
            <div class="p-4">
                <div class="flex items-center space-x-3 mb-6 p-3 glass-card rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center"><span id="userInitials"></span></div>
                    <div><p id="userName"></p><p id="userRole" class="text-xs text-indigo-200"></p></div>
                </div>
                <nav id="sidebar-nav">
                    <a id="nav-ai-tutor" href="#" class="flex items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition"><i data-feather="message-square" class="w-5 h-5"></i><span>AI Tutor</span></a>
                    <a id="nav-study-materials" href="#" class="flex items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition"><i data-feather="file-text" class="w-5 h-5"></i><span>Study Materials</span></a>
                    <a id="nav-quizzes" href="#" class="flex items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition"><i data-feather="check-square" class="w-5 h-5"></i><span>Quizzes</span></a>
                    <a id="nav-admin-dashboard" href="#" class="hidden items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition"><i data-feather="sliders" class="w-5 h-5"></i><span>Admin Dashboard</span></a>
                </nav>
            </div>
        </div>
        <div class="mt-auto p-4 border-t border-indigo-400/20">
            <a href="#" id="logout-btn" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white/10 transition"><i data-feather="log-out" class="w-5 h-5"></i><span>Log Out</span></a>
        </div>
    </div>

    <main class="ml-64 p-8 min-h-screen">
        <div id="main-content" class="view">
             <header class="flex justify-between items-center mb-8"><h2 class="text-2xl font-bold text-gray-800">AI Tutor</h2></header>
            <p>El dashboard para alumnos irá aquí.</p>
        </div>

        <div id="teacher-panel" class="view">
            <div id="quiz-list-view" class="view active">
                <header class="flex justify-between items-center mb-8"><h2 class="text-2xl font-bold text-gray-800">My Quizzes</h2><button id="create-quiz-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition flex items-center gap-2"><i data-feather="plus" class="w-4 h-4"></i> Create New Quiz</button></header>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Quiz Title</th><th class="px-6 py-3">Source Document</th><th class="px-6 py-3">Questions</th><th class="px-6 py-3">Date Created</th><th class="px-6 py-3">Actions</th></tr></thead><tbody id="quiz-table-body"></tbody></table></div></div>
            </div>
            <div id="quiz-analytics-view" class="view">
                <header class="mb-8"><button id="back-to-list-btn" class="text-indigo-600 hover:text-indigo-800 text-sm mb-4 flex items-center gap-2"><i data-feather="arrow-left" class="w-4 h-4"></i> Back to Quiz List</button><h2 id="analytics-title" class="text-2xl font-bold text-gray-800">Quiz Analytics</h2></header>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-green-100 p-3 rounded-full"><i data-feather="bar-chart-2" class="w-6 h-6 text-green-600"></i></div><div><p class="text-gray-500 text-sm">Average Score</p><p id="stats-avg-score" class="text-2xl font-bold">0%</p></div></div><div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-blue-100 p-3 rounded-full"><i data-feather="users" class="w-6 h-6 text-blue-600"></i></div><div><p class="text-gray-500 text-sm">Participants</p><p id="stats-participants" class="text-2xl font-bold">0</p></div></div></div>
                <div class="bg-white rounded-xl shadow-sm"><div class="p-6 border-b"><h3 class="text-lg font-medium">Individual Results</h3></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Student</th><th class="px-6 py-3">Score</th><th class="px-6 py-3">Date Taken</th></tr></thead><tbody id="results-table-body"></tbody></table></div></div>
            </div>
        </div>

        <div id="admin-panel" class="view">
            <header class="mb-8"><h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2></header><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-blue-100 p-3 rounded-full"><i data-feather="users" class="w-6 h-6 text-blue-600"></i></div><div><p class="text-gray-500 text-sm">Total Students</p><p id="stats-students" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-green-100 p-3 rounded-full"><i data-feather="user-check" class="w-6 h-6 text-green-600"></i></div><div><p class="text-gray-500 text-sm">Total Teachers</p><p id="stats-teachers" class="text-2xl font-bold">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-purple-100 p-3 rounded-full"><i data-feather="check-square" class="w-6 h-6 text-purple-600"></i></div><div><p class="text-gray-500 text-sm">Total Quizzes</p><p id="stats-quizzes" class="text-2xl font-bold">0</p></div></div></div><div class="bg-white rounded-xl shadow-sm"><div class="p-6 border-b flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><h3 class="text-lg font-medium">User Management</h3><div class="flex items-center gap-4"><input type="text" id="user-search-input" placeholder="Search by email..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><button id="addUserBtn" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition whitespace-nowrap"><i data-feather="plus" class="w-4 h-4 inline -mt-0.5"></i> Add New User</button></div></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">Email</th><th class="px-6 py-3">Role</th><th class="px-6 py-3">Actions</th></tr></thead><tbody id="user-table-body"></tbody></table></div></div>
        </div>
    </main>

    <div id="createQuizModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-xl shadow-lg w-full max-w-lg mx-4"><form id="createQuizForm" class="p-6"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-800">Create a New Quiz</h3><button type="button" class="close-modal-btn text-gray-500 hover:text-gray-700"><i data-feather="x" class="w-5 h-5"></i></button></div><div class="space-y-4"><div><label for="quizTitle" class="block text-sm font-medium text-gray-700 mb-1">Quiz Title</label><input type="text" id="quizTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g., Introduction to Photosynthesis"></div><div><label for="quizDoc" class="block text-sm font-medium text-gray-700 mb-1">Source Document (PDF)</label><input type="file" id="quizDoc" required accept=".pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div><div class="grid grid-cols-2 gap-4"><div><label for="numQuestions" class="block text-sm font-medium text-gray-700 mb-1">Number of Questions</label><input type="number" id="numQuestions" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="5" min="1" max="20"></div><div><label for="difficulty" class="block text-sm font-medium text-gray-700 mb-1">Difficulty</label><select id="difficulty" required class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="easy">Easy</option><option value="medium" selected>Medium</option><option value="hard">Hard</option></select></div></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" class="close-modal-btn px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg">Cancel</button><button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg">Generate Quiz</button></div></form></div></div>
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4"><form id="addUserForm" class="p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-800">Add New User</h3><button type="button" id="closeModalBtn" class="text-gray-500 hover:text-gray-700"><i data-feather="x" class="w-5 h-5"></i></button></div><div class="space-y-4"><div><label for="newUserEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="newUserEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div><label for="newUserPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="newUserPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div><label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label><select id="newUserRole" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="alumno">Student</option><option value="profesor">Teacher</option><option value="admin">Admin</option></select></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" id="cancelModalBtn" class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg transition">Cancel</button><button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg transition">Save User</button></div></form></div></div>

    <script>
        const user = { name: localStorage.getItem('userName') || '', role: localStorage.getItem('userRole') || 'alumno' };
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            updateUserInfo();
            setupDashboard();
            setupEventListeners();
        });
        function updateUserInfo() {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userInitials').textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const roleDisplay = { 'alumno': 'Student', 'profesor': 'Teacher', 'admin': 'Administrator' };
            document.getElementById('userRole').textContent = roleDisplay[user.role] || 'Unknown';
        }
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        function setupDashboard() {
            document.querySelectorAll('main > .view').forEach(v => v.classList.remove('active'));
            document.getElementById('nav-ai-tutor').classList.remove('hidden', 'active-tab');
            document.getElementById('nav-study-materials').classList.remove('hidden', 'active-tab');
            document.getElementById('nav-quizzes').classList.remove('hidden', 'active-tab');
            document.getElementById('nav-admin-dashboard').classList.add('hidden');
            document.getElementById('nav-admin-dashboard').classList.remove('active-tab');
            if (user.role === 'admin') {
                document.getElementById('admin-panel').classList.add('active');
                document.getElementById('nav-ai-tutor').classList.add('hidden');
                document.getElementById('nav-study-materials').classList.add('hidden');
                document.getElementById('nav-quizzes').classList.add('hidden');
                const adminNavLink = document.getElementById('nav-admin-dashboard');
                adminNavLink.classList.remove('hidden');
                adminNavLink.classList.add('active-tab', 'flex');
                loadAdminStats();
                loadUsersTable();
            } else if (user.role === 'profesor') {
                document.getElementById('teacher-panel').classList.add('active');
                document.getElementById('nav-quizzes').classList.add('active-tab');
                loadQuizList();
            } else { // Alumno
                document.getElementById('main-content').classList.add('active');
                document.getElementById('nav-ai-tutor').classList.add('active-tab');
            }
        }
        function setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); logout(); });
            const quizModal = document.getElementById('createQuizModal');
            document.getElementById('create-quiz-btn').addEventListener('click', () => quizModal.classList.remove('hidden'));
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => quizModal.classList.add('hidden')));
            document.getElementById('back-to-list-btn').addEventListener('click', showQuizListView);
            document.getElementById('createQuizForm').addEventListener('submit', handleCreateQuiz);
            const userModal = document.getElementById('addUserModal');
            document.getElementById('addUserBtn').addEventListener('click', () => userModal.classList.remove('hidden'));
            document.getElementById('closeModalBtn').addEventListener('click', () => userModal.classList.add('hidden'));
            document.getElementById('cancelModalBtn').addEventListener('click', () => userModal.classList.add('hidden'));
            document.getElementById('addUserForm').addEventListener('submit', handleAddNewUser);
            document.getElementById('user-search-input').addEventListener('keyup', (e) => loadUsersTable(e.target.value));
        }
        async function loadQuizList() {
            const response = await fetch('/api/teacher/quizzes');
            const quizzes = await response.json();
            const tableBody = document.getElementById('quiz-table-body');
            tableBody.innerHTML = '';
            if (quizzes.length === 0) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-gray-500">No quizzes created yet.</td></tr>'; return; }
            quizzes.forEach(quiz => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${quiz.title}</td><td class="px-6 py-4">${quiz.doc}</td><td class="px-6 py-4">${quiz.questions}</td><td class="px-6 py-4">${quiz.date}</td><td class="px-6 py-4 flex items-center gap-4"><button onclick="showAnalyticsView(${quiz.id}, '${quiz.title}')" class="text-green-600 hover:text-green-800" title="View Analytics"><i data-feather="bar-chart-2" class="w-5 h-5"></i></button><button title="Preview Quiz" class="text-blue-600 hover:text-blue-800"><i data-feather="eye" class="w-5 h-5"></i></button><button title="Delete Quiz" class="text-red-600 hover:text-red-800"><i data-feather="trash-2" class="w-5 h-5"></i></button></td>`;
                tableBody.appendChild(row);
            });
            feather.replace();
        }
        function showQuizListView() {
            document.getElementById('quiz-analytics-view').classList.remove('active');
            document.getElementById('quiz-list-view').classList.add('active');
        }
        
        async function showAnalyticsView(quizId, quizTitle) {
            document.getElementById('analytics-title').textContent = `Analytics for "${quizTitle}"`;
            const response = await fetch(`/api/teacher/quiz/${quizId}/analytics`);
            const data = await response.json();
            document.getElementById('stats-avg-score').textContent = `${data.avg || 0}%`;
            document.getElementById('stats-participants').textContent = data.participants || 0;
            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            if (!data.results || data.results.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-8 text-gray-500">No results submitted yet.</td></tr>';
            } else {
                data.results.forEach(res => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b';
                    row.innerHTML = `<td class="px-6 py-4 font-medium text-gray-900">${res.name}</td><td class="px-6 py-4">${res.score}%</td><td class="px-6 py-4">${res.date}</td>`;
                    tableBody.appendChild(row);
                });
            }
            document.getElementById('quiz-list-view').classList.remove('active');
            document.getElementById('quiz-analytics-view').classList.add('active');
        }
        async function handleCreateQuiz(event) {
            event.preventDefault();
            alert("Quiz creation functionality is not yet implemented.");
            document.getElementById('createQuizModal').classList.add('hidden');
        }
        async function loadAdminStats() {
            const response = await fetch('/api/admin/stats');
            const stats = await response.json();
            document.getElementById('stats-students').textContent = stats.students;
            document.getElementById('stats-teachers').textContent = stats.teachers;
            document.getElementById('stats-quizzes').textContent = stats.quizzes;
        }
        async function loadUsersTable(searchTerm = '') {
            const response = await fetch(`/api/admin/users?search=${encodeURIComponent(searchTerm)}`);
            const users = await response.json();
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `<td class="px-6 py-4">${user.id}</td><td class="px-6 py-4 font-medium text-gray-900">${user.username}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : (user.role === 'profesor' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800')}">${user.role}</span></td><td class="px-6 py-4"><button onclick="deleteUser(${user.id}, '${user.username}')" class="text-red-500 hover:text-red-700"><i data-feather="trash-2" class="w-4 h-4"></i></button></td>`;
                tableBody.appendChild(row);
            });
            feather.replace();
        }
        async function deleteUser(id, username) {
            if (confirm(`Are you sure you want to delete: ${username}?`)) {
                const response = await fetch('/api/admin/users/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: id }) });
                const result = await response.json();
                if (result.success) { loadUsersTable(); } 
                else { alert('Error: ' + result.message); }
            }
        }
        
        async function handleAddNewUser(event) {
            event.preventDefault();
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const response = await fetch('/api/admin/users/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password, role }) });
            const result = await response.json();
            if (result.success) {
                alert('User added successfully!');
                document.getElementById('addUserForm').reset();
                document.getElementById('addUserModal').classList.add('hidden');
                loadUsersTable();
            } else { alert('Error: ' + result.message); }
        }
    </script>
</body>
</html>
