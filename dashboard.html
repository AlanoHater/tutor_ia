<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EduAI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        /* /// LA CORRECCIÓN ESTÁ AQUÍ /// */
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .glass-card { backdrop-filter: blur(16px); background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .active-tab { background-color: rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <div class="fixed inset-y-0 left-0 w-64 gradient-bg text-white shadow-lg">
        <div class="flex items-center justify-center h-16 px-4 border-b border-indigo-400/20">
            <div class="flex items-center space-x-2">
                <i data-feather="book-open" class="w-8 h-8 text-indigo-200"></i>
                <h1 class="text-xl font-bold">EduAI Companion</h1>
            </div>
        </div>
        <div class="p-4">
            <div class="flex items-center space-x-3 mb-6 p-3 glass-card rounded-lg">
                <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center"><span id="userInitials"></span></div>
                <div><p id="userName"></p><p id="userRole" class="text-xs text-indigo-200"></p></div>
            </div>
            <nav id="sidebar-nav">
                <a id="nav-ai-tutor" href="#" class="flex items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition">
                    <i data-feather="message-square" class="w-5 h-5"></i><span>AI Tutor</span>
                </a>
                <a id="nav-study-materials" href="#" class="flex items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition">
                    <i data-feather="file-text" class="w-5 h-5"></i><span>Study Materials</span>
                </a>
                <a id="nav-quizzes" href="#" class="flex items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition">
                    <i data-feather="check-square" class="w-5 h-5"></i><span>Quizzes</span>
                </a>
                <a id="nav-admin-dashboard" href="#" class="hidden items-center space-x-3 p-3 mb-1 rounded-lg hover:bg-white/10 transition">
                    <i data-feather="sliders" class="w-5 h-5"></i><span>Admin Dashboard</span>
                </a>
            </nav>
        </div>
    </div>

    <div class="ml-64 p-8 min-h-screen">
        <div id="main-content">
            </div>

        <div id="admin-panel" class="hidden">
            <header class="mb-8"><h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2></header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-blue-100 p-3 rounded-full"><i data-feather="users" class="w-6 h-6 text-blue-600"></i></div><div><p class="text-gray-500 text-sm">Total Students</p><p id="stats-students" class="text-2xl font-bold">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-green-100 p-3 rounded-full"><i data-feather="user-check" class="w-6 h-6 text-green-600"></i></div><div><p class="text-gray-500 text-sm">Total Teachers</p><p id="stats-teachers" class="text-2xl font-bold">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4"><div class="bg-purple-100 p-3 rounded-full"><i data-feather="check-square" class="w-6 h-6 text-purple-600"></i></div><div><p class="text-gray-500 text-sm">Total Quizzes</p><p id="stats-quizzes" class="text-2xl font-bold">0</p></div></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm">
                <div class="p-6 border-b flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h3 class="text-lg font-medium">User Management</h3>
                    <div class="flex items-center gap-4">
                        <input type="text" id="user-search-input" placeholder="Search by email..." class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="addUserBtn" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition whitespace-nowrap"><i data-feather="plus" class="w-4 h-4 inline -mt-0.5"></i> Add New User</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">Email</th><th class="px-6 py-3">Role</th><th class="px-6 py-3">Actions</th></tr></thead><tbody id="user-table-body"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4">
            <form id="addUserForm" class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Add New User</h3>
                    <button type="button" id="closeModalBtn" class="text-gray-500 hover:text-gray-700"><i data-feather="x" class="w-5 h-5"></i></button>
                </div>
                <div class="space-y-4">
                    <div><label for="newUserEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="newUserEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div><label for="newUserPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="newUserPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div><label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label><select id="newUserRole" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="alumno">Student</option><option value="profesor">Teacher</option><option value="admin">Admin</option></select></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancelModalBtn" class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg transition">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const user = { name: localStorage.getItem('userName') || '', role: localStorage.getItem('userRole') || 'alumno' };

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userInitials').textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const roleDisplay = { 'alumno': 'Student', 'profesor': 'Teacher', 'admin': 'Administrator' };
            document.getElementById('userRole').textContent = roleDisplay[user.role] || 'Unknown';

            if (user.role === 'admin') {
                document.getElementById('nav-ai-tutor').classList.add('hidden');
                document.getElementById('nav-study-materials').classList.add('hidden');
                document.getElementById('nav-quizzes').classList.add('hidden');
                const adminNavLink = document.getElementById('nav-admin-dashboard');
                adminNavLink.classList.remove('hidden');
                adminNavLink.classList.add('active-tab');
                adminNavLink.classList.add('flex');
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadAdminStats();
                loadUsersTable();
                
                const addUserModal = document.getElementById('addUserModal');
                const addUserBtn = document.getElementById('addUserBtn');
                const closeModalBtn = document.getElementById('closeModalBtn');
                const cancelModalBtn = document.getElementById('cancelModalBtn');
                addUserBtn.addEventListener('click', () => addUserModal.classList.remove('hidden'));
                closeModalBtn.addEventListener('click', () => addUserModal.classList.add('hidden'));
                cancelModalBtn.addEventListener('click', () => addUserModal.classList.add('hidden'));
                document.getElementById('addUserForm').addEventListener('submit', handleAddNewUser);
                
                const searchInput = document.getElementById('user-search-input');
                searchInput.addEventListener('keyup', () => { loadUsersTable(searchInput.value); });
            } else {
                document.getElementById('nav-ai-tutor').classList.add('active-tab');
            }
        });
        
        async function handleAddNewUser(event) {
            event.preventDefault();
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const response = await fetch('/api/admin/users/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password, role }) });
            const result = await response.json();
            if (result.success) {
                alert('User added successfully!');
                document.getElementById('addUserForm').reset();
                document.getElementById('addUserModal').classList.add('hidden');
                loadUsersTable();
            } else { alert('Error: ' + result.message); }
        }

        async function loadAdminStats() {
            const response = await fetch('/api/admin/stats');
            const stats = await response.json();
            document.getElementById('stats-students').textContent = stats.students;
            document.getElementById('stats-teachers').textContent = stats.teachers;
            document.getElementById('stats-quizzes').textContent = stats.quizzes;
        }

        async function loadUsersTable(searchTerm = '') {
            const response = await fetch(`/api/admin/users?search=${encodeURIComponent(searchTerm)}`);
            const users = await response.json();
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `<td class="px-6 py-4">${user.id}</td><td class="px-6 py-4 font-medium text-gray-900">${user.username}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : (user.role === 'profesor' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800')}">${user.role}</span></td><td class="px-6 py-4"><button onclick="deleteUser(${user.id}, '${user.username}')" class="text-red-500 hover:text-red-700"><i data-feather="trash-2" class="w-4 h-4"></i></button></td>`;
                tableBody.appendChild(row);
            });
            feather.replace();
        }

        async function deleteUser(id, username) {
            if (confirm(`Are you sure you want to delete: ${username}?`)) {
                const response = await fetch('/api/admin/users/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: id }) });
                const result = await response.json();
                if (result.success) { loadUsersTable(); } 
                else { alert('Error: ' + result.message); }
            }
        }
    </script>
</body>
</html>
